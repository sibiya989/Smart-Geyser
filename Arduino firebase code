#include <ESP8266WiFi.h>
#include <FirebaseArduino.h>
#include <OneWire.h>
#include <DallasTemperature.h>

int greenLedPin = D1;
int yellowLedPin = D2;
int redLedPin = D3;

int temp_sensor = D5;

float temperature = 0;
float userTemperature = 0;
int lowerLimit = 30;
int higherLimit = 70;
                     
OneWire oneWirePin(temp_sensor);
DallasTemperature sensors(&oneWirePin);

#define FIREBASE_HOST "nodemcu-2a4e2.firebaseio.com"
#define FIREBASE_AUTH "bwDLCK226BGhiyxk5priRzKB6TbCYGH8iofQUkdd"
#define WIFI_SSID "CBD Res - The Foundation"
#define WIFI_PASSWORD "smart12345"


double i = 0;
double a = millis();
double c ;

int on_off = 0;  // led status received from firebase
int autoOn = 0;
int emergencyButton = 0;

 double Ttime2;
                                                             // for external led
void setup() {
   //Setup the LEDS to act as outputs
  pinMode(redLedPin,OUTPUT);
  pinMode(greenLedPin,OUTPUT);
  pinMode(yellowLedPin,OUTPUT);
  
  
  sensors.begin();
  Serial.begin(9600);
  delay(1000);
  pinMode(LED_BUILTIN, OUTPUT);   
  digitalWrite(LED_BUILTIN,LOW);
  
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);                                      //try to connect with wifi
  Serial.print("Connecting to ");
  Serial.print(WIFI_SSID);
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  Serial.println();
  Serial.print("Connected to ");
  Serial.println(WIFI_SSID);
  Serial.print("IP Address is : ");
  Serial.println(WiFi.localIP());                  //print local IP address
  Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH);    // connect to firebase
  
  Firebase.setInt("ON", 0);
  Firebase.setInt("AUTO_ON", 0);
  Firebase.setInt("Emergency", 0);
  Firebase.setInt("USERTEMP", 0);
  

  
}

void loop() 
{
  Firebase.setFloat("Temp",temperature );
  //NORMAL ON AND OFF
  on_off = Firebase.getInt("ON"); 
  higherLimit = Firebase.getInt("Temp");
  userTemperature = Firebase.getInt("USERTEMP");
 
  
  
  //AUTO ON AND OFF BASED ON ANDROID ALAR
  autoOn = Firebase.getInt("AUTO_ON");
  emergencyButton = Firebase.getInt("Emergency");
  Ttime2 = Firebase.getInt("Time");
  
   
  sensors.requestTemperatures();
  temperature = sensors.getTempCByIndex(0);

  if(emergencyButton != 1)
  {
    if(temperature <= lowerLimit   && on_off == 1)
    {
       Firebase.setInt("ON", 1);
      do{  
        Serial.println( userTemperature);
        
        Serial.println("Geyser ON");
        Ttime2 = Firebase.getInt("Time");
        Serial.print("Time: ");
         c = millis();
         i = (c - a) / 60000;
         Serial.println(i);
         Serial.println("......");
 
       //update firebase with the previous logedd time and the current time
         Firebase.setFloat("Time",Ttime2+ i); 
          delay(1000);
         digitalWrite(yellowLedPin, HIGH);
          Serial.println(userTemperature);
           Serial.println(higherLimit);
         
         }
      while( userTemperature != higherLimit && on_off  != 1);  
     
    }
    else if(temperature <= lowerLimit   && autoOn == 1)
    {
       Firebase.setInt("ON", 1);
      do{  
        Serial.println( userTemperature);
        
        Serial.println("Geyser ON");
        Ttime2 = Firebase.getInt("Time");
        Serial.print("Time: ");
         c = millis();
         i = (c - a) / 60000;
         Serial.println(i);
         Serial.println("......");
 
       //update firebase with the previous logedd time and the current time
         Firebase.setFloat("Time",Ttime2+ i); 
          delay(1000);
         digitalWrite(yellowLedPin, HIGH);
          Serial.println(userTemperature);
           Serial.println(higherLimit);
         
         }
      while( userTemperature != higherLimit && autoOn  != 1);  
     
    }
   
    
  } 
    else if(emergencyButton == 1)
    {
      Firebase.setInt("ON", 0);
      digitalWrite(yellowLedPin, LOW);
      Serial.println("OFF DUE TO EMERGENCY");
    }

  
 } 
